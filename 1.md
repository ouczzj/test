```mermaid
graph TD
    %% 定义样式
    classDef process fill:#E1F5FE,stroke:#01579B,stroke-width:2px;
    classDef storage fill:#FFF3E0,stroke:#FF6F00,stroke-width:2px,stroke-dasharray: 5 5;
    classDef aiModel fill:#E8F5E9,stroke:#2E7D32,stroke-width:2px;

    %% --- 阶段 1: 数据准备 ---
    subgraph Stage1_DataPrep [阶段一：数据摄入与预处理]
        A[非结构化文档<br>(PDF, TXT, MD等)] --> B(文档加载器<br>UnstructuredFileLoader);
        B --> C(文本切分/Chunking<br>RecursiveCharacterTextSplitter);
        C --> D[文本块<br>Text Chunks];
    end

    %% --- 阶段 2: 图谱构建与混合索引 ---
    subgraph Stage2_GraphConstruction [阶段二：图谱构建与混合索引 (核心)]
        D --输入--> E(信息抽取 LLM<br>Information Extraction);
        
        E --抽取实体与关系--> F[结构化图数据<br>(Nodes & Edges)];
        
        F --> G[(图数据库<br>如: Neo4j)];
        
        D --输入--> H(Embedding模型<br>文本向量化);
        H --生成向量--> I[向量索引<br>Vector Index];
        
        G <--建立关联--> I;
        style I fill:#FFF3E0,stroke:#FF6F00,stroke-width:2px,stroke-dasharray: 5 5
        
        note[文章代码注释:<br>代码中手动模拟了'结构化图数据'的构建过程,<br>实际生产中需依赖LLM自动抽取];
        F -.-> note;
    end

    %% --- 阶段 3: 检索阶段 ---
    subgraph Stage3_Retrieval [阶段三：混合检索]
        U[用户查询 Query] --> V(查询理解/路由器);
        
        %% 路径 A: 图数据库检索 (结构化)
        V --路径 A: 复杂关系查询--> W(Text-to-Cypher LLM<br>GraphCypherQAChain);
        W --生成 Cypher 语句--> G;
        G --返回图结构上下文--> X[结构化知识];
        
        %% 路径 B: 向量检索 (语义相似度)
        V --路径 B: 语义相关性查询--> Y(向量检索接口<br>Neo4jVector);
        Y --语义相似度搜索--> I;
        I --返回相关文本块--> Z[非结构化上下文];
        
        %% 合并
        X --> M(上下文融合与重排<br>Reranking);
        Z --> M;
        M --> FinalContext[最终增强上下文];
    end

    %% --- 阶段 4: 生成阶段 ---
    subgraph Stage4_Generation [阶段四：生成回答]
        FinalContext --> GenLLM(生成式 LLM<br>Chat Model);
        U --> GenLLM;
        GenLLM --> Answer[最终回答];
    end

    %% 应用样式
    class B,C,E,H,V,W,Y,M,GenLLM process;
    class G,I storage;
    class E,W,H,GenLLM aiModel;